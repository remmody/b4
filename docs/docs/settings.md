---
sidebar_position: 3
title: Общие настройки
description: Конфигурация основных параметров B4, сети, логирования и внешних сервисов
---

# Настройки

Страница настроек предоставляет централизованное управление всеми аспектами работы B4. Доступ через пункт **Settings** в боковом меню.

![settings](../static/img/settings/20251125200826.png)

## Обзор

Настройки организованы в следующих вкладках:

| Вкладка             | Описание                                                   |
| ------------------- | ---------------------------------------------------------- |
| **Core**            | Сетевая очередь, логирование, фаервол, управление системой |
| **Sets**            | Наборы конфигураций для разных сценариев обхода            |
| **Geodat Settings** | Управление базами GeoSite/GeoIP                            |
| **Testing**         | Параметры тестирования обхода DPI - служба `Discovery`     |
| **API**             | Учётные данные внешних сервисов                            |
| **Capture**         | Захват реальных payload                                    |

### Сохранение изменений

- Изменённые настройки отображают значок **Modified** в заголовке
- Нажмите **Save Changes** для применения изменений
- **Reload** отменяет несохранённые изменения и загружает текущую конфигурацию
- Изменения в Core требуют перезапуска службы B4

:::warning Сохранение
Не забывайте сохранять ваши изменения. Изменения отсылаются на сервер только при нажатии сверху кнопки `Save Changes`.
:::

## Core (Основные настройки)

### Network Configuration (Сетевые параметры)

Управление параметрами обработки очереди `netfilter`.

- **Queue Start Number**
  Номер очереди `netfilter` для перехвата пакетов, диаопозон `0–65535`.
  Значение по умолчанию - `537`.

- **Worker Threads**
  Потоки параллельной обработки пакетов. 1–16 (по умолчанию: `4`).

:::tip
Увеличьте количество потоков на высоконагруженных системах. Каждый поток обрабатывает пакеты независимо.
:::

### Core Controls (Управление системой)

Две критические операции:

- **Restart B4 System Service** — Перезапуск демона B4. Требуется после изменения настроек Core.
- **Reset to Default Settings** — Сброс к настройкам по умолчанию с сохранением:
  - Фильтров доменов и настроек geodata
  - Настроек чекера и тестовых доменов

:::tip Когда необходимо перезагружать B4?
Концепция приложения заключается в том, чтобы максимально исключить необходимость перезагрузки сервиса при внесении настроек. По сути, перезагружать сервис не нужно, если не меняются настройки из закладки `Core`.
:::

### Logging Configuration (Логирование)

| Параметр          | Описание                                       |
| ----------------- | ---------------------------------------------- |
| **Log Level**     | Уровень детализации: Error, Info, Trace, Debug |
| **Instant Flush** | Немедленная запись логов                       |
| **Syslog**        | Отправка логов в системный syslog              |

:::warning выключение логов
Логи не пишутся в файлы, тем самым не напрягая общую систему. При выключении логов (или переведя их в уровень Error) перестанут поступать логи в раздел `Logs` и [`Domains`](domains.md).
:::

### Feature Flags (Флаги функций)

**Proto Features - Протоколы:**

- **Enable IPv4 Support** — Обработка IPv4-трафика
- **Enable IPv6 Support** — Обработка IPv6-трафика

**Firewall Features - Фаервол:**

- **Skip IPTables/NFTables Setup** — Отключить автоматическую настройку правил фаервола. В `B4` существует встроенный механизм добавления необходимых правил в файрволл системы.
  Этим флагом его можно отключить при старте сервиса.
- **Firewall Monitor Interval** — Интервал проверки/восстановления правил B4 (0 отключает мониторинг).
  B4 может следить за состоянием своих правил, в случае их удаления сервис попытается их востановить. Полезно на роутерах, когда при перезагрузке файрволла правила могут очищаться.

:::warning
Установка интервала мониторинга в 0 отключает автоматическое восстановление правил. Если правила будут сброшены, B4 их не восстановит.
:::

---

## Sets (Наборы конфигураций)

Наборы конфигураций позволяют определять разные стратегии обхода DPI для разных доменов или сценариев.

Вкладка `Sets` предоставляет интерфейс для создания, редактирования, дублирования и организации наборов конфигураций. Каждый набор содержит собственные лимиты TCP/UDP, стратегии фрагментации, параметры фейкинга и целевые домены.

Конфигурационные сеты - краеугольный камень работы B4. Через сеты можно тонко настроить отдельную конфигурацию под тот или иной домен/ip/cidr/asn.

:::info
Подробная документация по созданию и настройке наборов описана в отдельном руководстве [Наборы конфигураций](sets).
:::

---

## Geodat Settings (Настройки Geodat)

Управление файлами баз GeoSite и GeoIP для категоризации доменов и IP-адресов.

### Что такое Geodat файлы

B4 использует формат geodat-файлов от [проектов V2Ray/Xray](https://github.com/v2fly) — бинарные базы данных для категоризации доменов и IP-адресов. Это позволяет одной строкой (`youtube` или `google`) охватить тысячи связанных доменов вместо ручного добавления каждого.

#### geosite.dat — база доменов

Содержит списки доменов, организованные по категориям. Каждая категория — это текстовый файл в репозитории, который компилируется в единый бинарный файл.

**Типы категорий:**

| Тип            | Примеры                                                      | Описание                                |
| -------------- | ------------------------------------------------------------ | --------------------------------------- |
| По сервису     | `youtube`, `google`, `facebook`, `twitter`                   | Все домены конкретного сервиса          |
| По стране      | `cn`, `ru`, `ir`                                             | Домены, относящиеся к стране            |
| Мета-категории | `category-ads-all`, `category-media`, `category-vpnservices` | Объединение нескольких категорий        |
| Геолокация     | `geolocation-cn`, `geolocation-!cn`                          | Домены внутри/вне определённого региона |
| Специальные    | `private`, `tld-cn`, `tld-!cn`                               | Приватные домены, TLD по регионам       |

**Примеры популярных категорий:**

- `youtube` — youtube.com, googlevideo.com, ytimg.com и сотни CDN-доменов
- `google` — все сервисы Google включая поиск, Gmail, Drive, Maps
- `telegram` — домены и IP-адреса Telegram
- `category-ads-all` — агрегация всех рекламных доменов
- `geolocation-!cn` — домены вне Китая (полезно для bypass в РФ)

#### geoip.dat — база IP-адресов

Содержит CIDR-диапазоны IP-адресов, сгруппированные по категориям (обычно по странам).

**Типы категорий:**

| Тип         | Примеры                  | Описание                                                |
| ----------- | ------------------------ | ------------------------------------------------------- |
| По стране   | `cn`, `ru`, `us`, `de`   | IP-диапазоны страны (двухбуквенный код ISO)             |
| Специальные | `private`                | Приватные диапазоны (10.0.0.0/8, 192.168.0.0/16 и т.д.) |
| По сервису  | `telegram`, `cloudflare` | IP-диапазоны конкретных сервисов                        |

### Источники Geodat файлов

B4 поддерживает несколько источников geodat:

#### Для России (RUNETFREEDOM)

Специализированный источник для российских пользователей с автоматически обновляемыми списками заблокированных ресурсов.

| Файл        | Репозиторий                                                                                   | Описание                                     |
| ----------- | --------------------------------------------------------------------------------------------- | -------------------------------------------- |
| geosite.dat | [runetfreedom/russia-v2ray-rules-dat](https://github.com/runetfreedom/russia-v2ray-rules-dat) | Заблокированные домены + все категории v2fly |
| geoip.dat   | [runetfreedom/russia-blocked-geoip](https://github.com/runetfreedom/russia-blocked-geoip)     | IP-адреса заблокированных ресурсов           |

#### Официальные (v2fly)

| Файл        | Репозиторий                                                                   | Описание                                               |
| ----------- | ----------------------------------------------------------------------------- | ------------------------------------------------------ |
| geosite.dat | [v2fly/domain-list-community](https://github.com/v2fly/domain-list-community) | Официальный список доменов, поддерживается сообществом |
| geoip.dat   | [v2fly/geoip](https://github.com/v2fly/geoip)                                 | Официальный GeoIP, на основе MaxMind                   |

#### Расширенные (Loyalsoldier)

| Файл        | Репозиторий                                                                     | Особенности                                                     |
| ----------- | ------------------------------------------------------------------------------- | --------------------------------------------------------------- |
| geosite.dat | [Loyalsoldier/v2ray-rules-dat](https://github.com/Loyalsoldier/v2ray-rules-dat) | Дополнительные категории: `google-cn`, `apple-cn`, `china-list` |
| geoip.dat   | [Loyalsoldier/geoip](https://github.com/Loyalsoldier/geoip)                     | Улучшенные данные для Китая (IPIP.net + gaoyifan)               |

**Обновление:** каждые 6 часов

:::tip Рекомендация для России
**RUNETFREEDOM** — оптимальный выбор для пользователей в России. Содержит актуальные списки блокировок из нескольких источников и является официальным источником российских geo-файлов для v2rayN.
:::

### Категории RUNETFREEDOM

#### geoip.dat — IP-адреса

**Основные категории блокировок:**

| Категория              | Источник                      | Описание                                |
| ---------------------- | ----------------------------- | --------------------------------------- |
| `ru-blocked`           | antifilter.download           | IP из `ipresolve.lst` и `subnet.lst`    |
| `ru-blocked-community` | community.antifilter.download | Сообщество antifilter (`community.lst`) |
| `re-filter`            | re:filter                     | IP из `ipsum.lst`                       |

**Дополнительные категории по сервисам (на основе ASN):**

| Категория    | Описание                                                 |
| ------------ | -------------------------------------------------------- |
| `cloudflare` | IP-диапазоны Cloudflare CDN                              |
| `cloudfront` | Amazon CloudFront                                        |
| `facebook`   | Meta (Facebook, Instagram, WhatsApp)                     |
| `fastly`     | Fastly CDN                                               |
| `google`     | Google и все сервисы                                     |
| `netflix`    | Netflix                                                  |
| `telegram`   | Telegram                                                 |
| `twitter`    | Twitter/X                                                |
| `ddos-guard` | DDoS-Guard (часто используется заблокированными сайтами) |
| `yandex`     | Яндекс                                                   |

#### geosite.dat — домены

Включает **все категории из v2fly/domain-list-community** плюс специфичные для России:

**Категории блокировок:**

| Категория                       | Описание                          | Примечание                            |
| ------------------------------- | --------------------------------- | ------------------------------------- |
| `ru-blocked`                    | Заблокированные домены            | antifilter-community + re:filter      |
| `ru-blocked-all`                | Все известные заблокированные     | 700K+ доменов, использовать осторожно |
| `antifilter-download`           | Полный список antifilter.download | ~700K доменов                         |
| `antifilter-download-community` | Сообщество antifilter             | Курируемый список                     |
| `refilter`                      | Домены из re:filter               | Альтернативный источник               |

**Специальные категории:**

| Категория                  | Описание                           |
| -------------------------- | ---------------------------------- |
| `ru-available-only-inside` | Домены, доступные только из России |
| `category-ads-all`         | Все рекламные домены               |
| `win-spy`                  | Windows: телеметрия и аналитика    |
| `win-update`               | Windows: серверы обновлений        |
| `win-extra`                | Windows: прочие системные домены   |

:::danger Осторожно с большими списками
Категории `ru-blocked-all` и `antifilter-download` содержат сотни тысяч записей. Это может:

- Увеличить потребление памяти
- Замедлить загрузку конфигурации
- Включать ложные срабатывания

Для большинства случаев достаточно `ru-blocked` или `ru-blocked-community`.
:::

### Использование в B4

После загрузки geodat файлов категории становятся доступны в редакторе наборов (Sets):

1. Перейдите в **Settings → Sets**
2. Откройте редактирование набора
3. Во вкладке **Targets** выберите нужные категории из выпадающего списка

![geo](../static/img/settings/20251125204157.png)

B4 автоматически разворачивает категории в полный список доменов/IP при загрузке конфигурации. В интерфейсе отображается количество записей в каждой категории.

### Обновление баз

Geodat файлы обновляются авторами регулярно:

- **v2fly** — ежемесячно (geoip), несколько раз в неделю (geosite)
- **Loyalsoldier** — ежедневно (автоматическая сборка через GitHub Actions)

Для обновления баз повторно загрузите файлы через интерфейс **Settings → Geodat Settings → Download Files**.

![geodat](../static/img/settings/20251125204034.png)

### Current Files (Текущие файлы)

Отображает статус настроенных файлов geodat:

- **Geosite Database** — Категоризация доменов (например, `youtube`, `google`, `facebook`)
- **GeoIP Database** — Категоризация IP-диапазонов по странам/организациям

Для каждого показывается: путь, URL источника, размер файла и дата изменения.

### Download Files (Загрузка файлов)

Два способа получения файлов geodat:

**Готовые источники:**
Выберите из предопределённых источников в выпадающем списке. Это поддерживаемые сообществом базы с регулярно обновляемыми списками доменов/IP.

**Собственные URL:**
Укажите прямые ссылки на файлы `geosite.dat` и `geoip.dat` для кастомных или self-hosted баз.

| Поле                   | Описание                                                    |
| ---------------------- | ----------------------------------------------------------- |
| **Preset Source**      | Выбор предопределённого источника geodat                    |
| **Destination Path**   | Директория для загруженных файлов (по умолчанию: `/etc/b4`) |
| **Custom Geosite URL** | Прямая ссылка на geosite.dat                                |
| **Custom GeoIP URL**   | Прямая ссылка на geoip.dat                                  |

:::tip Перезагрузка?
Нет, перезагружать B4 нет необходимости, после обновления или перезакачивания геоданных.
:::

---

## Testing (Тестирование)

Настройка поведения `Discovery` обхода DPI.

| Параметр                 | Описание                   | Диапазон     |
| ------------------------ | -------------------------- | ------------ |
| **Max Concurrent Tests** | Параллельные тесты доменов | 1–20         |
| **Test Timeout**         | Таймаут запроса на домен   | 1–120 секунд |

Эти настройки влияют на функциональность страницы **Test**, где проверяется эффективность обхода для конкретных доменов.

---

## API

Настройка учётных данных внешних сервисов.

### IPINFO.IO Settings

| Параметр  | Описание                                                                   |
| --------- | -------------------------------------------------------------------------- |
| **Token** | API-токен с [ipinfo.io/dashboard/token](https://ipinfo.io/dashboard/token) |

Используется для определения геолокации IP в разделе Domains, предоставляя информацию об `ASN` и организации для IP-адресов назначения.
:::tip ipinfo.io
Совет подключить [ipinfo.io](https://ipinfo.io/dashboard/token), это даст возможность маркировать пакеты в разделе `/domains` тем самым сопряжая разные ip в большом потоке соединений. Сервис предлагает 10000 запросов в неделю, что с лихвой должно хватить для личного использования.
:::

---

## Capture (Захват пакетов)

Захват реальных пакетов TLS ClientHello и QUIC Initial из живого трафика. Эти данные можно использовать для кастомных конфигураций фейкинга.
:::danger В разработке
Эта опция все еще в стадии разработки и полностью не реализована. Пока что ее стоит игнорировать.
:::
